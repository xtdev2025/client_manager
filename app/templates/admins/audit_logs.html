{% extends "layout.html" %}

{% block title %}Registros de Auditoria - Client Manager{% endblock %}

{% block page_title %}Registros de Auditoria{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Filtrar Registros</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin.audit_logs') }}" class="row g-3">
            <!-- Filtros Principais -->
            <div class="col-lg-4 col-md-6">
                <label for="entity_type" class="form-label fw-bold">Tipo de Entidade</label>
                <select name="entity_type" id="entity_type" class="form-select">
                    <option value="">Todos os Tipos</option>
                    <option value="admin" {% if filters.entity_type == 'admin' %}selected{% endif %}>Admin</option>
                    <option value="client" {% if filters.entity_type == 'client' %}selected{% endif %}>Cliente</option>
                    <option value="plan" {% if filters.entity_type == 'plan' %}selected{% endif %}>Plano</option>
                    <option value="domain" {% if filters.entity_type == 'domain' %}selected{% endif %}>Domínio</option>
                    <option value="template" {% if filters.entity_type == 'template' %}selected{% endif %}>Template</option>
                    <option value="info" {% if filters.entity_type == 'info' %}selected{% endif %}>Info</option>
                </select>
            </div>
            
            <div class="col-lg-4 col-md-6">
                <label for="action" class="form-label fw-bold">Ação</label>
                <select name="action" id="action" class="form-select">
                    <option value="">Todas as Ações</option>
                    <option value="create" {% if filters.action == 'create' %}selected{% endif %}>Criar</option>
                    <option value="update" {% if filters.action == 'update' %}selected{% endif %}>Atualizar</option>
                    <option value="delete" {% if filters.action == 'delete' %}selected{% endif %}>Deletar</option>
                    <option value="login" {% if filters.action == 'login' %}selected{% endif %}>Login</option>
                    <option value="logout" {% if filters.action == 'logout' %}selected{% endif %}>Logout</option>
                </select>
            </div>
            
            <div class="col-lg-4 col-md-6">
                <label for="user_id" class="form-label fw-bold">Usuário</label>
                <select name="user_id" id="user_id" class="form-select">
                    <option value="">Todos os Usuários</option>
                    {% for admin in admins %}
                    <option value="{{ admin._id }}" {% if filters.user_id == admin._id|string %}selected{% endif %}>
                        {{ admin.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filtros de Data -->
            <div class="col-lg-4 col-md-6">
                <label for="start_date" class="form-label fw-bold">Data Início</label>
                <input type="date" name="start_date" id="start_date" class="form-control" 
                       value="{{ filters.start_date }}" placeholder="Selecione a data inicial">
            </div>

            <div class="col-lg-4 col-md-6">
                <label for="end_date" class="form-label fw-bold">Data Fim</label>
                <input type="date" name="end_date" id="end_date" class="form-control" 
                       value="{{ filters.end_date }}" placeholder="Selecione a data final">
            </div>

            <!-- Botões de Ação -->
            <div class="col-12 d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-2"></i>Aplicar Filtros
                </button>
                <a href="{{ url_for('admin.audit_logs') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Limpar Filtros
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Entradas do Registro de Auditoria</h5>
        <div>
            <span class="badge bg-light text-dark me-2">Total: {{ total }}</span>
            {% if total > 0 %}
            <button type="button" class="btn btn-sm btn-danger" id="clearAllLogsBtn">
                <i class="fas fa-trash-alt me-1"></i>Limpar Todos os Logs
            </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Usuário</th>
                        <th>Tipo de Entidade</th>
                        <th>Ação</th>
                        <th>ID da Entidade</th>
                        <th>Endereço IP</th>
                        <th>Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>
                            <small>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') if log.timestamp else 'N/A' }}</small>
                        </td>
                        <td>
                            {% if log.user_id %}
                            <code class="text-primary">{{ log.user_id[:8] }}...</code>
                            {% else %}
                            <span class="text-muted">Sistema</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.entity_type == 'admin' %}
                            <span class="badge bg-danger">Admin</span>
                            {% elif log.entity_type == 'client' %}
                            <span class="badge bg-success">Cliente</span>
                            {% elif log.entity_type == 'plan' %}
                            <span class="badge bg-info">Plano</span>
                            {% elif log.entity_type == 'domain' %}
                            <span class="badge bg-warning">Domain</span>
                            {% elif log.entity_type == 'template' %}
                            <span class="badge bg-secondary">Template</span>
                            {% else %}
                            <span class="badge bg-dark">{{ log.entity_type }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.action == 'create' %}
                            <span class="badge bg-success">Create</span>
                            {% elif log.action == 'update' %}
                            <span class="badge bg-warning">Update</span>
                            {% elif log.action == 'delete' %}
                            <span class="badge bg-danger">Delete</span>
                            {% elif log.action == 'login' %}
                            <span class="badge bg-info">Login</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ log.action }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.entity_id %}
                            <code class="text-muted">{{ log.entity_id[:8] }}...</code>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td><small>{{ log.ip_address if log.ip_address else 'N/A' }}</small></td>
                        <td>
                            {% if log.details %}
                            <button type="button" class="btn btn-sm btn-outline-secondary view-details-btn"
                                    data-timestamp="{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') if log.timestamp else 'N/A' }}"
                                    data-user-id="{{ log.user_id if log.user_id else 'N/A' }}"
                                    data-entity-type="{{ log.entity_type }}"
                                    data-action="{{ log.action }}"
                                    data-entity-id="{{ log.entity_id if log.entity_id else 'N/A' }}"
                                    data-ip-address="{{ log.ip_address if log.ip_address else 'N/A' }}"
                                    data-user-agent="{{ log.user_agent if log.user_agent else 'N/A' }}"
                                    data-details='{{ log.details|tojson }}'>
                                <i class="fas fa-info-circle"></i> Ver
                            </button>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-info-circle me-2"></i>Nenhum registro de auditoria encontrado com os filtros atuais.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav aria-label="Audit logs pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                <!-- Previous -->
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.audit_logs', page=page-1, entity_type=filters.entity_type, action=filters.action, user_id=filters.user_id, start_date=filters.start_date, end_date=filters.end_date) }}">
                        Previous
                    </a>
                </li>

                <!-- Page numbers -->
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                    <li class="page-item active">
                        <span class="page-link">{{ p }}</span>
                    </li>
                    {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin.audit_logs', page=p, entity_type=filters.entity_type, action=filters.action, user_id=filters.user_id, start_date=filters.start_date, end_date=filters.end_date) }}">
                            {{ p }}
                        </a>
                    </li>
                    {% elif p == page - 3 or p == page + 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}

                <!-- Next -->
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.audit_logs', page=page+1, entity_type=filters.entity_type, action=filters.action, user_id=filters.user_id, start_date=filters.start_date, end_date=filters.end_date) }}">
                        Next
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}

        <div class="text-center text-muted mt-3">
            <small>
                Mostrando {{ ((page - 1) * per_page) + 1 }} até {{ [page * per_page, total]|min }} de {{ total }} entradas
            </small>
        </div>
    </div>
</div>

<!-- Modal Único Reutilizável de Detalhes -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Detalhes do Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Data/Hora:</dt>
                            <dd class="col-sm-8" id="modal-timestamp"></dd>
                            
                            <dt class="col-sm-4">ID do Usuário:</dt>
                            <dd class="col-sm-8"><code id="modal-user-id" class="text-break"></code></dd>
                            
                            <dt class="col-sm-4">Tipo de Entidade:</dt>
                            <dd class="col-sm-8" id="modal-entity-type"></dd>
                            
                            <dt class="col-sm-4">Ação:</dt>
                            <dd class="col-sm-8" id="modal-action"></dd>
                            
                            <dt class="col-sm-4">ID da Entidade:</dt>
                            <dd class="col-sm-8"><code id="modal-entity-id" class="text-break"></code></dd>
                            
                            <dt class="col-sm-4">Endereço IP:</dt>
                            <dd class="col-sm-8" id="modal-ip-address"></dd>
                            
                            <dt class="col-sm-4">User Agent:</dt>
                            <dd class="col-sm-8"><small id="modal-user-agent" class="text-break"></small></dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-2">Detalhes:</h6>
                        <!-- Container do Monaco Editor -->
                        <div id="monaco-editor" style="height: 300px; border: 1px solid #ddd; border-radius: 4px;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Limpar Todos os Logs -->
<div class="modal fade" id="confirmClearLogsModal" tabindex="-1" aria-labelledby="confirmClearLogsLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmClearLogsLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong>Aviso:</strong> Você está prestes a deletar <span class="text-danger">TODAS as {{ total }} entradas de auditoria</span>.</p>
                <p class="mb-3">Esta ação não pode ser desfeita. Todo o histórico de auditoria será permanentemente removido.</p>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmClearCheckbox">
                    <label class="form-check-label" for="confirmClearCheckbox">
                        Eu entendo que esta ação é irreversível
                    </label>
                </div>
                <p class="text-muted small mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Isto irá deletar todos os registros de auditoria do banco de dados.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{{ url_for('admin.clear_audit_logs') }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger" id="confirmClearBtn" disabled>
                        <i class="fas fa-trash-alt me-1"></i>Deletar Todos os Logs
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Load Monaco Editor -->
<script>
(function() {
    // Load Monaco Editor loader
    const loaderScript = document.createElement('script');
    loaderScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js';
    loaderScript.onload = function() {
        // Configure Monaco after loader is ready
        require.config({ 
            paths: { 
                vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' 
            }
        });
    };
    document.head.appendChild(loaderScript);
})();
</script>

<script>
// Monaco Editor instance
let monacoEditor = null;
let monacoInitialized = false;

// Handle view details button clicks
document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('detailsModal');
    
    // Initialize Monaco Editor when modal is first shown
    modalElement.addEventListener('shown.bs.modal', function() {
        if (!monacoEditor && typeof require !== 'undefined') {
            require(['vs/editor/editor.main'], function() {
                if (!monacoEditor) {
                    try {
                        monacoEditor = monaco.editor.create(document.getElementById('monaco-editor'), {
                            value: '{\n  "loading": "...",\n  "status": "Initializing editor..."\n}',
                            language: 'json',
                            theme: 'vs',
                            readOnly: true,
                            minimap: { enabled: false },
                            scrollBeyondLastLine: false,
                            fontSize: 13,
                            lineNumbers: 'on',
                            folding: true,
                            automaticLayout: true,
                            wordWrap: 'on'
                        });
                        monacoInitialized = true;
                    } catch (e) {
                        console.error('Error creating Monaco editor:', e);
                    }
                }
            });
        }
    });
    
    // Cleanup Monaco Editor when modal is hidden
    modalElement.addEventListener('hidden.bs.modal', function() {
        if (monacoEditor) {
            try {
                monacoEditor.dispose();
            } catch (e) {
                console.error('Error disposing Monaco editor:', e);
            }
            monacoEditor = null;
            monacoInitialized = false;
        }
    });
    
    document.querySelectorAll('.view-details-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Get data from button attributes
            document.getElementById('modal-timestamp').textContent = this.dataset.timestamp;
            document.getElementById('modal-user-id').textContent = this.dataset.userId;
            document.getElementById('modal-entity-type').textContent = this.dataset.entityType;
            document.getElementById('modal-action').textContent = this.dataset.action;
            document.getElementById('modal-entity-id').textContent = this.dataset.entityId;
            document.getElementById('modal-ip-address').textContent = this.dataset.ipAddress;
            document.getElementById('modal-user-agent').textContent = this.dataset.userAgent;
            
            // Show the modal first
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
            modalInstance.show();
            
            // Wait a bit for Monaco to initialize, then set the value
            setTimeout(function() {
                try {
                    let detailsData = button.dataset.details;
                    
                    // Verificar se os dados existem e não estão vazios
                    if (!detailsData || detailsData.trim() === '') {
                        throw new Error('Dados de detalhes vazios');
                    }
                    
                    // Parse JSON
                    const details = JSON.parse(detailsData);
                    const formattedJson = JSON.stringify(details, null, 2);
                    
                    if (monacoEditor && monacoInitialized) {
                        monacoEditor.setValue(formattedJson);
                    }
                } catch (e) {
                    console.error('Erro ao processar detalhes:', e);
                    // Fallback: mostrar dados brutos ou mensagem de erro
                    const errorMessage = {
                        "erro": "Não foi possível processar os detalhes",
                        "mensagem": e.message,
                        "dados_brutos": button.dataset.details || 'Nenhum dado disponível'
                    };
                    
                    if (monacoEditor && monacoInitialized) {
                        monacoEditor.setValue(JSON.stringify(errorMessage, null, 2));
                    }
                }
            }, 500);
        });
    });
    
    // Clear all logs modal handlers
    const clearAllBtn = document.getElementById('clearAllLogsBtn');
    const confirmClearModal = document.getElementById('confirmClearLogsModal');
    const confirmCheckbox = document.getElementById('confirmClearCheckbox');
    const confirmBtn = document.getElementById('confirmClearBtn');
    
    if (clearAllBtn && confirmClearModal) {
        clearAllBtn.addEventListener('click', function() {
            const modalInstance = bootstrap.Modal.getOrCreateInstance(confirmClearModal);
            modalInstance.show();
            
            // Reset checkbox and button state when modal opens
            if (confirmCheckbox) {
                confirmCheckbox.checked = false;
            }
            if (confirmBtn) {
                confirmBtn.disabled = true;
            }
        });
    }
    
    // Enable/disable confirm button based on checkbox
    if (confirmCheckbox && confirmBtn) {
        confirmCheckbox.addEventListener('change', function() {
            confirmBtn.disabled = !this.checked;
        });
    }
});
</script>
{% endblock %}
