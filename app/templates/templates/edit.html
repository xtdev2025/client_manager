{% extends "layout.html" %}

{% block title %}Editar Modelo - Gerenciador de Clientes{% endblock %}

{% block page_title %}Editar modelo{% endblock %}

{% block styles %}
<style>
    .template-edit-container {
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .config-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .config-section h6 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .page-list-item {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
        background: #f8f9fa;
        transition: all 0.2s;
    }
    
    .page-list-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .page-list-item.page-home {
        border-left: 4px solid #28a745;
    }
    
    .page-list-item.page-fixed {
        border-left: 4px solid #ffc107;
        background: #fffbf0;
    }
    
    .page-list-item.page-home.page-fixed {
        border-left: 4px solid #28a745;
        background: #f0fff4;
    }
    
    .drag-handle {
        cursor: move;
        color: #6c757d;
        font-size: 1.2rem;
    }
    
    .drag-handle:hover {
        color: #495057;
    }
    
    .page-list-item.dragging {
        opacity: 0.5;
    }
    
    @media (max-width: 992px) {
        .template-edit-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('template.edit_template', template_id=template._id) }}" id="templateForm">
                        {% include "partials/csrf_field.html" %}
                        
                        <div class="template-edit-container">
                            <!-- LEFT COLUMN: Template Basic Config -->
                            <div class="config-section">
                                <h6><i class="fas fa-cog me-2"></i>Configurações Básicas</h6>
                                
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nome do Template</label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                        value="{{ template.name }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="slug" class="form-label">Slug (URL)</label>
                                    <input type="text" class="form-control" id="slug" name="slug" 
                                        value="{{ template.slug }}" readonly>
                                    <small class="form-text text-muted">Gerado automaticamente a partir do nome</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Descrição</label>
                                    <textarea class="form-control" id="description" name="description" 
                                        rows="3">{{ template.description }}</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="active" {% if template.status == 'active' %}selected{% endif %}>Ativo</option>
                                        <option value="inactive" {% if template.status == 'inactive' %}selected{% endif %}>Inativo</option>
                                    </select>
                                </div>
                            </div>

                            <!-- RIGHT COLUMN: Pages Management -->
                            <div class="config-section">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Páginas</h6>
                                    <button type="button" class="btn btn-sm btn-success" id="addPageBtn">
                                        <i class="fas fa-plus me-1"></i>Nova Página
                                    </button>
                                </div>
                                
                                <small class="text-muted d-block mb-3">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Arraste para reordenar. Apenas uma página pode ser marcada como "Home".
                                </small>
                                
                                <div id="pagesList">
                                    {% if template.pages %}
                                        {% for page in template.pages %}
                                        <div class="page-list-item {% if page.type == 'home' %}page-home{% endif %}" 
                                             data-page-index="{{ loop.index0 }}" draggable="true">
                                            <div class="d-flex align-items-start gap-3">
                                                <div class="drag-handle">
                                                    <i class="fas fa-grip-vertical"></i>
                                                </div>
                                                
                                                <div class="flex-grow-1">
                                                    <div class="row g-2 mb-2">
                                                        <div class="col-md-4">
                                                            <label class="form-label small mb-1">Nome</label>
                                                            <input type="text" class="form-control form-control-sm page-name-input" 
                                                                name="pages[{{ loop.index0 }}][name]" 
                                                                value="{{ page.name }}" required>
                                                            <label class="form-label small mb-1 mt-2">Slug</label>
                                                            <div class="input-group input-group-sm">
                                                                <span class="input-group-text text-muted">/</span>
                                                                <input type="text" class="form-control form-control-sm page-slug-input"
                                                                    name="pages[{{ loop.index0 }}][slug]"
                                                                    value="{{ (page.slug or page.id)|e }}"
                                                                    data-manual="true"
                                                                    pattern="[a-z0-9_\-]+"
                                                                    maxlength="80"
                                                                    placeholder="ex: pagina_interna">
                                                            </div>
                                                            <small class="text-muted">Utilizado para acessar esta página pela URL pública.</small>
                                                        </div>
                                                        {% set page_type_value = page.get('type') %}
                                                        <div class="col-md-3">
                                                            <label class="form-label small mb-1">Tipo <span class="text-muted">(opcional)</span></label>
                                                            <select class="form-select form-select-sm page-type-select" 
                                                                name="pages[{{ loop.index0 }}][type]">
                                                                <option value="" {% if not page_type_value %}selected{% endif %}>Sem tipo</option>
                                                                <option value="home" {% if page_type_value == 'home' %}selected{% endif %}>Home</option>
                                                                <option value="custom" {% if page_type_value == 'custom' %}selected{% endif %}>Personalizada</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label class="form-label small mb-1">Ordem</label>
                                                            <input type="number" class="form-control form-control-sm page-order" 
                                                                name="pages[{{ loop.index0 }}][order]" 
                                                                value="{{ page.order if page.order else loop.index }}" 
                                                                min="1" required>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label small mb-1">Opções</label>
                                                            <div class="form-check">
                                                                <input type="checkbox" class="form-check-input page-fixed-checkbox" 
                                                                    name="pages[{{ loop.index0 }}][fixed]" 
                                                                    id="page_fixed_{{ loop.index0 }}"
                                                                    value="true"
                                                                    {% if page.fixed %}checked{% endif %}>
                                                                <label class="form-check-label small" for="page_fixed_{{ loop.index0 }}">
                                                                    <i class="fas fa-lock me-1"></i>Página Fixa
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <input type="hidden" name="pages[{{ loop.index0 }}][id]" value="{{ page.id }}">
                                                    <input type="hidden" class="page-content-input" 
                                                        name="pages[{{ loop.index0 }}][content]" 
                                                        value="{{ page.content|e if page.content else '' }}">
                                                    
                                                    <div class="d-flex gap-2 mt-2">
                                                        <button type="button" class="btn btn-sm btn-outline-primary edit-html-btn"
                                                            data-page-index="{{ loop.index0 }}">
                                                            <i class="fas fa-code me-1"></i>Editar HTML
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger remove-page-btn"
                                                            {% if page.fixed %}disabled title="Páginas fixas não podem ser removidas"{% endif %}>
                                                            <i class="fas fa-trash me-1"></i>Remover
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted text-center py-3">Nenhuma página adicionada ainda</p>
                                    {% endif %}
                                </div>
                                <br>

                                 <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Páginas</h6>
                                    <button type="button" class="btn btn-sm btn-success" id="addPageBtn">
                                        <i class="fas fa-plus me-1"></i>Nova Página
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 justify-content-end mt-4">
                            <a href="{{ url_for('template.list_templates') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Editing HTML -->
<div class="modal fade" id="htmlEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-code me-2"></i>Editar HTML da Página: <span id="modalPageName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 0; position: relative;">
                <div id="monacoEditorContainer" style="height: 500px; width: 100%;"></div>
                <div id="editorLoading" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div class="text-center text-white">
                        <div class="spinner-border mb-3" role="status"></div>
                        <div>Carregando editor...</div>
                    </div>
                </div>
                <small class="text-muted d-block mt-2 px-3 pb-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Escreva o HTML completo da página. Você pode usar Bootstrap 5 classes.
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveHtmlBtn">
                    <i class="fas fa-save me-1"></i>Salvar HTML
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Page Template (Hidden) -->
<template id="pageTemplate">
    <div class="page-list-item" draggable="true">
        <div class="d-flex align-items-start gap-3">
            <div class="drag-handle">
                <i class="fas fa-grip-vertical"></i>
            </div>
            
            <div class="flex-grow-1">
                <div class="row g-2 mb-2">
                    <div class="col-md-4">
                        <label class="form-label small mb-1">Nome</label>
                        <input type="text" class="form-control form-control-sm page-name-input" 
                            name="" placeholder="Nome da página" required>
                        <label class="form-label small mb-1 mt-2">Slug</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text text-muted">/</span>
                            <input type="text" class="form-control form-control-sm page-slug-input"
                                name=""
                                data-manual="false"
                                pattern="[a-z0-9_\-]+"
                                maxlength="80"
                                placeholder="ex: nova_pagina">
                        </div>
                        <small class="text-muted">Personalize o caminho da URL.</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small mb-1">Tipo <span class="text-muted">(opcional)</span></label>
                        <select class="form-select form-select-sm page-type-select" name="">
                            <option value="" selected>Sem tipo</option>
                            <option value="home">Home</option>
                            <option value="custom">Personalizada</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Ordem</label>
                        <input type="number" class="form-control form-control-sm page-order" 
                            name="" value="1" min="1" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small mb-1">Opções</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input page-fixed-checkbox" 
                                name="" value="true" id="">
                            <label class="form-check-label small" for="">
                                <i class="fas fa-lock me-1"></i>Página Fixa
                            </label>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" class="page-id-input" name="" value="">
                <input type="hidden" class="page-content-input" name="" value="">
                
                <div class="d-flex gap-2 mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary edit-html-btn">
                        <i class="fas fa-code me-1"></i>Editar HTML
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-page-btn">
                        <i class="fas fa-trash me-1"></i>Remover
                    </button>
                </div>
            </div>
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
let currentEditingPageIndex = null;
let pageCounter = Number('{{ template.pages|length if template.pages else 0 }}');
const htmlEditorModal = new bootstrap.Modal(document.getElementById('htmlEditorModal'));
let monacoEditor = null;

const templateNameInput = document.getElementById('name');
const templateSlugInput = document.getElementById('slug');

function generateSlug(text) {
    if (!text) {
        return '';
    }

    const stringValue = text.toString();
    const normalized = stringValue.normalize ? stringValue.normalize('NFD') : stringValue;

    return normalized
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s\-_]/g, '')
        .replace(/\s+/g, '_')
        .replace(/_+/g, '_');
}

// Load Monaco Editor
require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});

require(['vs/editor/editor.main'], function () {
    monacoEditor = monaco.editor.create(document.getElementById('monacoEditorContainer'), {
        value: '',
        language: 'html',
        theme: 'vs-dark',
        automaticLayout: true,
        minimap: { enabled: true },
        fontSize: 14,
        tabSize: 2,
        wordWrap: 'on',
        formatOnPaste: true,
        formatOnType: true
    });
    
    // Hide loading indicator
    const loadingEl = document.getElementById('editorLoading');
    if (loadingEl) {
        loadingEl.style.display = 'none';
    }
    
    console.log('✓ Monaco Editor initialized');
});

// Auto-generate slug from template name (read-only field)
if (templateNameInput && templateSlugInput) {
    templateNameInput.addEventListener('input', function() {
        templateSlugInput.value = generateSlug(this.value);
    });
}

// Add new page
document.getElementById('addPageBtn').addEventListener('click', function() {
    const template = document.getElementById('pageTemplate');
    const clone = template.content.cloneNode(true);
    const pageItem = clone.querySelector('.page-list-item');
    
    pageItem.setAttribute('data-page-index', pageCounter);
    
    // Update all name attributes with proper detection
    const nameInput = pageItem.querySelector('.page-name-input');
    if (nameInput) nameInput.setAttribute('name', `pages[${pageCounter}][name]`);
    
    const typeSelect = pageItem.querySelector('.page-type-select');
    if (typeSelect) typeSelect.setAttribute('name', `pages[${pageCounter}][type]`);
    
    const orderInput = pageItem.querySelector('.page-order');
    if (orderInput) {
        orderInput.setAttribute('name', `pages[${pageCounter}][order]`);
        orderInput.value = pageCounter + 1;
    }

    const slugInput = pageItem.querySelector('.page-slug-input');
    if (slugInput) {
        slugInput.setAttribute('name', `pages[${pageCounter}][slug]`);
        slugInput.value = '';
        slugInput.dataset.manual = 'false';
    }
    
    const idInput = pageItem.querySelector('.page-id-input');
    if (idInput) {
        idInput.setAttribute('name', `pages[${pageCounter}][id]`);
        idInput.value = `page_${Date.now()}`;
    }
    
    const contentInput = pageItem.querySelector('.page-content-input');
    if (contentInput) contentInput.setAttribute('name', `pages[${pageCounter}][content]`);
    
    const fixedCheckbox = pageItem.querySelector('.page-fixed-checkbox');
    if (fixedCheckbox) {
        fixedCheckbox.setAttribute('name', `pages[${pageCounter}][fixed]`);
        fixedCheckbox.setAttribute('id', `page_fixed_${pageCounter}`);
        const fixedLabel = pageItem.querySelector('.form-check-label');
        if (fixedLabel) fixedLabel.setAttribute('for', `page_fixed_${pageCounter}`);
    }
    
    // Update edit button
    const editBtn = pageItem.querySelector('.edit-html-btn');
    editBtn.setAttribute('data-page-index', pageCounter);
    
    document.getElementById('pagesList').appendChild(pageItem);
    
    // Attach event listeners
    attachPageEvents(pageItem);
    
    pageCounter++;
});

// Edit HTML button
document.addEventListener('click', function(e) {
    if (e.target.closest('.edit-html-btn')) {
        e.preventDefault();
        const btn = e.target.closest('.edit-html-btn');
        const pageItem = btn.closest('.page-list-item');
        
        if (!pageItem) {
            console.error('Page item not found');
            return;
        }
        
        const pageIndex = pageItem.getAttribute('data-page-index');
        
        // Safely get page name
        const nameInput = pageItem.querySelector('[name*="[name]"]');
        const pageName = nameInput && nameInput.value ? nameInput.value : 'Nova Página';
        const contentInput = pageItem.querySelector('.page-content-input');
        
        currentEditingPageIndex = pageIndex;
        document.getElementById('modalPageName').textContent = pageName;
        
        // Check if Monaco Editor is ready
        if (!monacoEditor) {
            // Show loading and wait
            const checkEditor = setInterval(() => {
                if (monacoEditor) {
                    clearInterval(checkEditor);
                    monacoEditor.setValue(contentInput && contentInput.value ? contentInput.value : '');
                    htmlEditorModal.show();
                }
            }, 100);
            
            // Timeout after 5 seconds
            setTimeout(() => {
                clearInterval(checkEditor);
                if (!monacoEditor) {
                    alert('Erro ao carregar o editor. Por favor, recarregue a página.');
                }
            }, 5000);
        } else {
            // Monaco is ready, set value and show
            monacoEditor.setValue(contentInput && contentInput.value ? contentInput.value : '');
            htmlEditorModal.show();
        }
    }
});

// Save HTML from modal
document.getElementById('saveHtmlBtn').addEventListener('click', function() {
    const html = monacoEditor ? monacoEditor.getValue() : '';
    const pageItem = document.querySelector(`[data-page-index="${currentEditingPageIndex}"]`);
    const contentInput = pageItem.querySelector('.page-content-input');
    
    contentInput.value = html;
    htmlEditorModal.hide();
    
    // Show success feedback
    const btn = pageItem.querySelector('.edit-html-btn');
    btn.innerHTML = '<i class="fas fa-check me-1"></i>HTML Salvo';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-code me-1"></i>Editar HTML';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-primary');
    }, 2000);
});

// Remove page
document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-page-btn')) {
        const removeBtn = e.target.closest('.remove-page-btn');
        
        // Check if button is disabled (fixed page)
        if (removeBtn.disabled) {
            alert('Esta página é fixa e não pode ser removida. Desmarque a opção "Página Fixa" para poder removê-la.');
            return;
        }
        
        if (confirm('Tem certeza que deseja remover esta página?')) {
            const pageItem = e.target.closest('.page-list-item');
            pageItem.remove();
            reindexPages();
        }
    }
});

// Handle fixed checkbox changes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('page-fixed-checkbox')) {
        const pageItem = e.target.closest('.page-list-item');
        const removeBtn = pageItem.querySelector('.remove-page-btn');
        
        if (e.target.checked) {
            // Disable remove button for fixed pages
            removeBtn.disabled = true;
            removeBtn.setAttribute('title', 'Páginas fixas não podem ser removidas');
            pageItem.classList.add('page-fixed');
        } else {
            // Enable remove button
            removeBtn.disabled = false;
            removeBtn.removeAttribute('title');
            pageItem.classList.remove('page-fixed');
        }
    }
});

// Validate only one home page
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('page-type-select')) {
        if (e.target.value === 'home') {
            // Remove home from all other pages
            document.querySelectorAll('.page-type-select').forEach(select => {
                if (select !== e.target && select.value === 'home') {
                    select.value = 'custom';
                    select.closest('.page-list-item').classList.remove('page-home');
                }
            });
            e.target.closest('.page-list-item').classList.add('page-home');
        } else {
            e.target.closest('.page-list-item').classList.remove('page-home');
        }
    }
});

// Drag and Drop
let draggedItem = null;

document.addEventListener('dragstart', function(e) {
    if (e.target.classList.contains('page-list-item')) {
        draggedItem = e.target;
        e.target.classList.add('dragging');
    }
});

document.addEventListener('dragend', function(e) {
    if (e.target.classList.contains('page-list-item')) {
        e.target.classList.remove('dragging');
        reindexPages();
    }
});

document.addEventListener('dragover', function(e) {
    e.preventDefault();
    const afterElement = getDragAfterElement(document.getElementById('pagesList'), e.clientY);
    const pagesList = document.getElementById('pagesList');
    
    if (afterElement == null) {
        pagesList.appendChild(draggedItem);
    } else {
        pagesList.insertBefore(draggedItem, afterElement);
    }
});

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.page-list-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function attachSlugSync(pageItem) {
    const nameInput = pageItem.querySelector('.page-name-input');
    const slugInput = pageItem.querySelector('.page-slug-input');

    if (!nameInput || !slugInput) {
        return;
    }

    const syncSlug = () => {
        if (slugInput.dataset.manual === 'true') {
            return;
        }
        slugInput.value = generateSlug(nameInput.value);
    };

    if (!slugInput.dataset.manual) {
        slugInput.dataset.manual = slugInput.value.trim() ? 'true' : 'false';
    }

    if (!slugInput.value.trim()) {
        slugInput.dataset.manual = 'false';
        syncSlug();
    }

    nameInput.addEventListener('input', () => {
        if (!slugInput.value.trim()) {
            slugInput.dataset.manual = 'false';
        }
        syncSlug();
    });

    slugInput.addEventListener('input', () => {
        slugInput.dataset.manual = slugInput.value.trim() ? 'true' : 'false';
        if (!slugInput.value.trim()) {
            syncSlug();
        }
    });
}

function reindexPages() {
    const pages = document.querySelectorAll('.page-list-item');
    pages.forEach((page, index) => {
        page.setAttribute('data-page-index', index);
        
        // Update all name attributes
        page.querySelectorAll('[name^="pages["]').forEach(input => {
            const currentName = input.getAttribute('name');
            const newName = currentName.replace(/pages\[\d+\]/, `pages[${index}]`);
            input.setAttribute('name', newName);
        });
        
        // Update order
        const orderInput = page.querySelector('.page-order');
        if (orderInput) {
            orderInput.value = index + 1;
        }
        
        // Update edit button
        const editBtn = page.querySelector('.edit-html-btn');
        if (editBtn) {
            editBtn.setAttribute('data-page-index', index);
        }
    });
}

function attachPageEvents(pageItem) {
    pageItem.setAttribute('draggable', 'true');
    attachSlugSync(pageItem);
}

// Attach events to existing pages
document.querySelectorAll('.page-list-item').forEach(attachPageEvents);

console.log('✓ Template editor initialized');
</script>
{% endblock %}
