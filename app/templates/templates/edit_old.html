{% extends "layout.html" %}

{% block title %}Editar Modelo - Gerenciador de Clientes{% endblock %}

{% block page_title %}Editar modelo{% endblock %}

{% block styles %}
<style>
    .nav-tabs .nav-link {
        color: #495057;
    }
    .nav-tabs .nav-link.active {
        font-weight: 600;
    }
    .page-item {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 15px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }
    .page-item.required {
        border-left: 4px solid #28a745;
    }
    .login-type-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem;
        border-radius: 0.25rem;
        background-color: #e9ecef;
        font-size: 0.875rem;
    }
    .color-preview {
        width: 40px;
        height: 40px;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
    }
    
    /* Field Manager Styles */
    .fields-manager {
        background-color: #f8f9fa !important;
    }
    .field-order-list {
        min-height: 60px;
        max-height: 300px;
        overflow-y: auto;
    }
    .field-order-item {
        cursor: move;
        user-select: none;
        transition: background-color 0.2s;
    }
    .field-order-item:hover {
        background-color: #e9ecef;
    }
    .field-order-item.dragging {
        opacity: 0.5;
        background-color: #dee2e6;
    }
    .field-order-item.drag-over {
        border-top: 3px solid #007bff;
    }
    .field-checkboxes .form-check {
        margin-bottom: 0.5rem;
    }
    
    /* Two Column Layout */
    .template-config-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }
    .template-config-left {
        flex: 1;
        min-width: 400px;
    }
    .template-config-right {
        flex: 1;
        min-width: 400px;
    }
    .config-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .config-section h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }
    .sticky-pages {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-warning">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Editar: {{ template.name }}</h5>
                    <span class="badge bg-info">Slug: {{ template.slug }}</span>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('template.edit_template', template_id=template._id) }}" id="templateForm">
                    
                    <div class="template-config-container">
                        <!-- LEFT COLUMN: Template Configuration -->
                        <div class="template-config-left">
                            
                            <!-- Basic Information -->
                            <div class="config-section">
                                <h6><i class="fas fa-info-circle me-2"></i>Informações Básicas</h6>
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nome do Modelo<span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" name="name" value="{{ template.name }}" required>
                                    <small class="text-muted">O slug será gerado automaticamente: <code>{{ template.slug }}</code></small>
                                </div>
                                <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="active" {% if template.status == 'active' %}selected{% endif %}>Ativo</option>
                                        <option value="inactive" {% if template.status == 'inactive' %}selected{% endif %}>Inativo</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Descrição</label>
                                    <textarea class="form-control" id="description" name="description" rows="2">{{ template.description }}</textarea>
                                </div>
                            </div>

                            <!-- Header Configuration -->
                            <div class="config-section">
                                <h6><i class="fas fa-heading me-2"></i>Configuração do Header</h6>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="headerEnabled" name="header[enabled]" 
                                        value="true" {% if template.header and template.header.enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="headerEnabled">Habilitar Header</label>
                                </div>
                                <div class="mb-3">
                                    <label for="headerLogo" class="form-label">URL do Logo</label>
                                    <input type="url" class="form-control" id="headerLogo" name="header[logo]" 
                                        value="{{ template.header.logo if template.header else '' }}" placeholder="https://example.com/logo.png">
                                </div>
                                <div class="mb-3">
                                    <label for="headerBgColor" class="form-label">Cor de Fundo</label>
                                    <div class="input-group">
                                        <input type="color" class="form-control form-control-color" id="headerBgColor" name="header[backgroundColor]" 
                                            value="{{ template.header.backgroundColor if template.header else '#ffffff' }}">
                                        <input type="text" class="form-control" id="headerBgColorText" 
                                            value="{{ template.header.backgroundColor if template.header else '#ffffff' }}" readonly>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="headerContent" class="form-label">Conteúdo HTML</label>
                                    <textarea class="form-control font-monospace" id="headerContent" name="header[content]" 
                                        rows="3">{{ template.header.content if template.header else '' }}</textarea>
                                </div>
                            </div>

                            <!-- Footer Configuration -->
                            <div class="config-section">
                                <h6><i class="fas fa-shoe-prints me-2"></i>Configuração do Footer</h6>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="footerEnabled" name="footer[enabled]" 
                                        value="true" {% if template.footer and template.footer.enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="footerEnabled">Habilitar Footer</label>
                                </div>
                                <div class="mb-3">
                                    <label for="footerBgColor" class="form-label">Cor de Fundo</label>
                                    <div class="input-group">
                                        <input type="color" class="form-control form-control-color" id="footerBgColor" name="footer[backgroundColor]" 
                                            value="{{ template.footer.backgroundColor if template.footer else '#f8f9fa' }}">
                                        <input type="text" class="form-control" id="footerBgColorText" 
                                            value="{{ template.footer.backgroundColor if template.footer else '#f8f9fa' }}" readonly>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="footerContent" class="form-label">Conteúdo HTML</label>
                                    <textarea class="form-control font-monospace" id="footerContent" name="footer[content]" 
                                        rows="3">{{ template.footer.content if template.footer else '' }}</textarea>
                                </div>
                            </div>

                            <!-- Versions Configuration -->
                            <div class="config-section">
                                <h6><i class="fas fa-mobile-alt me-2"></i>Versões Mobile/Desktop</h6>
                                
                                <!-- Mobile Version -->
                                <div class="mb-4">
                                    <h6 class="text-muted small">Mobile</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="mobileEnabled" name="versions[mobile][enabled]" 
                                            value="true" {% if template.versions and template.versions.mobile and template.versions.mobile.enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="mobileEnabled">Habilitar versão mobile</label>
                                    </div>
                                    <div class="mb-2">
                                        <label for="mobileCustomCss" class="form-label small">CSS Customizado</label>
                                        <textarea class="form-control font-monospace" id="mobileCustomCss" name="versions[mobile][customCss]" 
                                            rows="3">{{ template.versions.mobile.customCss if template.versions and template.versions.mobile else '' }}</textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label for="mobileCustomJs" class="form-label small">JavaScript Customizado</label>
                                        <textarea class="form-control font-monospace" id="mobileCustomJs" name="versions[mobile][customJs]" 
                                            rows="3">{{ template.versions.mobile.customJs if template.versions and template.versions.mobile else '' }}</textarea>
                                    </div>
                                </div>

                                <!-- Desktop Version -->
                                <div class="mb-3">
                                    <h6 class="text-muted small">Desktop</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="desktopEnabled" name="versions[desktop][enabled]" 
                                            value="true" {% if template.versions and template.versions.desktop and template.versions.desktop.enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="desktopEnabled">Habilitar versão desktop</label>
                                    </div>
                                    <div class="mb-2">
                                        <label for="desktopCustomCss" class="form-label small">CSS Customizado</label>
                                        <textarea class="form-control font-monospace" id="desktopCustomCss" name="versions[desktop][customCss]" 
                                            rows="3">{{ template.versions.desktop.customCss if template.versions and template.versions.desktop else '' }}</textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label for="desktopCustomJs" class="form-label small">JavaScript Customizado</label>
                                        <textarea class="form-control font-monospace" id="desktopCustomJs" name="versions[desktop][customJs]" 
                                            rows="3">{{ template.versions.desktop.customJs if template.versions and template.versions.desktop else '' }}</textarea>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- RIGHT COLUMN: Pages Configuration -->
                        <div class="template-config-right">
                            <div class="sticky-pages">
                                <div class="config-section">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Páginas do Template</h6>
                                        <button type="button" class="btn btn-sm btn-primary" id="addPageBtn">
                                            <i class="fas fa-plus me-1"></i>Adicionar Página
                                        </button>
                                    </div>
                                    
                                    <div id="pagesList">
                                {% if template.pages %}
                                    {% for page in template.pages %}
                                    <div class="page-item {% if page.required %}required{% endif %}" data-page-index="{{ loop.index0 }}">
                                        <div class="row align-items-center">
                                            <div class="col-md-3">
                                                <label class="form-label small">ID da Página</label>
                                                <input type="text" class="form-control form-control-sm" name="pages[{{ loop.index0 }}][id]" 
                                                    value="{{ page.id }}" {% if page.required %}readonly{% endif %}>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Nome</label>
                                                <input type="text" class="form-control form-control-sm" name="pages[{{ loop.index0 }}][name]" 
                                                    value="{{ page.name }}" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Tipo</label>
                                                <select class="form-select form-select-sm page-type-select" name="pages[{{ loop.index0 }}][type]" 
                                                    {% if page.required %}disabled{% endif %}>
                                                    <option value="home" {% if page.type == 'home' %}selected{% endif %}>Home</option>
                                                    <option value="splashscreen" {% if page.type == 'splashscreen' %}selected{% endif %}>Splashscreen</option>
                                                    <option value="login" {% if page.type == 'login' %}selected{% endif %}>Login</option>
                                                    <option value="custom" {% if page.type == 'custom' %}selected{% endif %}>Customizada</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 text-end">
                                                {% if not page.required %}
                                                <button type="button" class="btn btn-sm btn-danger remove-page-btn">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {% else %}
                                                <span class="badge bg-success">Obrigatória</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Login Type Section (only for login pages) -->
                                        <div class="login-types-section mt-3" style="{% if page.type != 'login' %}display:none;{% endif %}">
                                            <label class="form-label small">Tipos de Login</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="pages[{{ loop.index0 }}][loginTypes][]" 
                                                    value="user_pass" id="login_{{ loop.index0 }}_user_pass" 
                                                    {% if page.loginTypes and 'user_pass' in page.loginTypes %}checked{% endif %}>
                                                <label class="form-check-label" for="login_{{ loop.index0 }}_user_pass">
                                                    Login + Senha
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="pages[{{ loop.index0 }}][loginTypes][]" 
                                                    value="agency_account_pass" id="login_{{ loop.index0 }}_agency" 
                                                    {% if page.loginTypes and 'agency_account_pass' in page.loginTypes %}checked{% endif %}>
                                                <label class="form-check-label" for="login_{{ loop.index0 }}_agency">
                                                    Agência + Conta + Senha
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="pages[{{ loop.index0 }}][loginTypes][]" 
                                                    value="phone" id="login_{{ loop.index0 }}_phone" 
                                                    {% if page.loginTypes and 'phone' in page.loginTypes %}checked{% endif %}>
                                                <label class="form-check-label" for="login_{{ loop.index0 }}_phone">
                                                    Celular
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="pages[{{ loop.index0 }}][loginTypes][]" 
                                                    value="cpf" id="login_{{ loop.index0 }}_cpf" 
                                                    {% if page.loginTypes and 'cpf' in page.loginTypes %}checked{% endif %}>
                                                <label class="form-check-label" for="login_{{ loop.index0 }}_cpf">
                                                    CPF
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="pages[{{ loop.index0 }}][loginTypes][]" 
                                                    value="selfie" id="login_{{ loop.index0 }}_selfie" 
                                                    {% if page.loginTypes and 'selfie' in page.loginTypes %}checked{% endif %}>
                                                <label class="form-check-label" for="login_{{ loop.index0 }}_selfie">
                                                    Selfie
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="pages[{{ loop.index0 }}][loginTypes][]" 
                                                    value="document" id="login_{{ loop.index0 }}_document" 
                                                    {% if page.loginTypes and 'document' in page.loginTypes %}checked{% endif %}>
                                                <label class="form-check-label" for="login_{{ loop.index0 }}_document">
                                                    Documento
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Duration for splashscreen -->
                                        <div class="mt-3 splashscreen-duration" style="{% if page.type != 'splashscreen' %}display:none;{% endif %}">
                                            <label class="form-label small">Duração (ms)</label>
                                            <input type="number" class="form-control form-control-sm" name="pages[{{ loop.index0 }}][duration]" 
                                                value="{{ page.duration if page.duration else 3000 }}" min="1000" max="10000">
                                        </div>

                                        <div class="mt-3">
                                            <label class="form-label small">Campos da Página</label>
                                            <div class="fields-manager border rounded p-3 bg-light" data-page-index="{{ loop.index0 }}">
                                                <div class="available-fields mb-3">
                                                    <small class="text-muted d-block mb-2">Selecione os campos a exibir:</small>
                                                    <div class="field-checkboxes">
                                                        <div class="form-check">
                                                            <input class="form-check-input field-checkbox" type="checkbox" 
                                                                value="login_password" id="field_{{ loop.index0 }}_login_password"
                                                                data-label="Login + Senha"
                                                                {% if page.fields %}
                                                                    {% for field in page.fields %}
                                                                        {% if field.type == 'login_password' %}checked{% endif %}
                                                                    {% endfor %}
                                                                {% endif %}>
                                                            <label class="form-check-label" for="field_{{ loop.index0 }}_login_password">
                                                                Login + Senha
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input field-checkbox" type="checkbox" 
                                                                value="agency_account_password" id="field_{{ loop.index0 }}_agency"
                                                                data-label="Agência + Conta + Senha"
                                                                {% if page.fields %}
                                                                    {% for field in page.fields %}
                                                                        {% if field.type == 'agency_account_password' %}checked{% endif %}
                                                                    {% endfor %}
                                                                {% endif %}>
                                                            <label class="form-check-label" for="field_{{ loop.index0 }}_agency">
                                                                Agência + Conta + Senha
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input field-checkbox" type="checkbox" 
                                                                value="phone" id="field_{{ loop.index0 }}_phone"
                                                                data-label="Celular"
                                                                {% if page.fields %}
                                                                    {% for field in page.fields %}
                                                                        {% if field.type == 'phone' %}checked{% endif %}
                                                                    {% endfor %}
                                                                {% endif %}>
                                                            <label class="form-check-label" for="field_{{ loop.index0 }}_phone">
                                                                Celular
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input field-checkbox" type="checkbox" 
                                                                value="cpf" id="field_{{ loop.index0 }}_cpf"
                                                                data-label="CPF"
                                                                {% if page.fields %}
                                                                    {% for field in page.fields %}
                                                                        {% if field.type == 'cpf' %}checked{% endif %}
                                                                    {% endfor %}
                                                                {% endif %}>
                                                            <label class="form-check-label" for="field_{{ loop.index0 }}_cpf">
                                                                CPF
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input field-checkbox" type="checkbox" 
                                                                value="selfie" id="field_{{ loop.index0 }}_selfie"
                                                                data-label="Selfie"
                                                                {% if page.fields %}
                                                                    {% for field in page.fields %}
                                                                        {% if field.type == 'selfie' %}checked{% endif %}
                                                                    {% endfor %}
                                                                {% endif %}>
                                                            <label class="form-check-label" for="field_{{ loop.index0 }}_selfie">
                                                                Selfie
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input field-checkbox" type="checkbox" 
                                                                value="document" id="field_{{ loop.index0 }}_document"
                                                                data-label="Documento"
                                                                {% if page.fields %}
                                                                    {% for field in page.fields %}
                                                                        {% if field.type == 'document' %}checked{% endif %}
                                                                    {% endfor %}
                                                                {% endif %}>
                                                            <label class="form-check-label" for="field_{{ loop.index0 }}_document">
                                                                Documento
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="selected-fields">
                                                    <small class="text-muted d-block mb-2">Ordem dos campos (arraste para reordenar):</small>
                                                    <ul class="field-order-list list-group" id="fieldList_{{ loop.index0 }}">
                                                        {% if page.fields %}
                                                            {% for field in page.fields | sort(attribute='order') %}
                                                            <li class="list-group-item d-flex justify-content-between align-items-center field-order-item" 
                                                                draggable="true" data-field-type="{{ field.type }}">
                                                                <span><i class="fas fa-grip-vertical me-2 text-muted"></i>{{ field.label }}</span>
                                                                <input type="hidden" name="pages[{{ loop.index0 }}][fields][{{ loop.index }}][type]" value="{{ field.type }}">
                                                                <input type="hidden" name="pages[{{ loop.index0 }}][fields][{{ loop.index }}][label]" value="{{ field.label }}">
                                                                <input type="hidden" class="field-order-input" name="pages[{{ loop.index0 }}][fields][{{ loop.index }}][order]" value="{{ field.order }}">
                                                            </li>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </ul>
                                                    <div class="empty-message text-muted text-center py-3" style="{% if page.fields and page.fields|length > 0 %}display:none;{% endif %}">
                                                        Selecione campos acima para adicioná-los à página
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="d-flex flex-column flex-sm-row gap-2 justify-content-end mt-4">
                        <a href="{{ url_for('template.list_templates') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>Atualizar modelo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Page Template (hidden) -->
<template id="pageTemplate">
    <div class="page-item" data-page-index="">
        <div class="row align-items-center">
            <div class="col-md-3">
                <label class="form-label small">ID da Página</label>
                <input type="text" class="form-control form-control-sm page-id-input" name="" placeholder="ex: login_page">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Nome</label>
                <input type="text" class="form-control form-control-sm" name="" placeholder="ex: Login" required>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Tipo</label>
                <select class="form-select form-select-sm page-type-select" name="">
                    <option value="login">Login</option>
                    <option value="custom">Customizada</option>
                </select>
            </div>
            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-sm btn-danger remove-page-btn">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        
        <div class="login-types-section mt-3">
            <label class="form-label small">Tipos de Login</label>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="user_pass">
                <label class="form-check-label">Login + Senha</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="agency_account_pass">
                <label class="form-check-label">Agência + Conta + Senha</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="phone">
                <label class="form-check-label">Celular</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="cpf">
                <label class="form-check-label">CPF</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="selfie">
                <label class="form-check-label">Selfie</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="document">
                <label class="form-check-label">Documento</label>
            </div>
        </div>

        <div class="mt-3">
            <label class="form-label small">Conteúdo HTML</label>
            <textarea class="form-control form-control-sm font-monospace" name="" rows="3"></textarea>
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('✓ Template edit form initialized');
    
    // Initialize field management for all pages
    document.querySelectorAll('.fields-manager').forEach(function(manager) {
        initFieldManager(manager);
    });
    
    // Handle page type changes (show/hide login types and duration)
    document.querySelectorAll('.page-type-select').forEach(function(select) {
        select.addEventListener('change', function() {
            const pageItem = this.closest('.page-item');
            const loginSection = pageItem.querySelector('.login-types-section');
            const durationSection = pageItem.querySelector('.splashscreen-duration');
            
            if (this.value === 'login') {
                if (loginSection) loginSection.style.display = 'block';
            } else {
                if (loginSection) loginSection.style.display = 'none';
            }
            
            if (this.value === 'splashscreen') {
                if (durationSection) durationSection.style.display = 'block';
            } else {
                if (durationSection) durationSection.style.display = 'none';
            }
        });
    });
});

function initFieldManager(manager) {
    const pageIndex = manager.dataset.pageIndex;
    const fieldCheckboxes = manager.querySelectorAll('.field-checkbox');
    const fieldList = manager.querySelector('.field-order-list');
    const emptyMessage = manager.querySelector('.empty-message');
    
    // Handle checkbox changes
    fieldCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                addFieldToList(fieldList, this.value, this.dataset.label, pageIndex, emptyMessage);
            } else {
                removeFieldFromList(fieldList, this.value);
            }
            updateEmptyMessage(fieldList, emptyMessage);
            updateFieldOrders(fieldList, pageIndex);
        });
    });
    
    // Initialize drag and drop
    enableDragAndDrop(fieldList, pageIndex, emptyMessage);
    
    // Set initial empty message state
    updateEmptyMessage(fieldList, emptyMessage);
}

function addFieldToList(list, fieldType, fieldLabel, pageIndex, emptyMessage) {
    // Check if field already exists
    const existing = list.querySelector(`[data-field-type="${fieldType}"]`);
    if (existing) return;
    
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center field-order-item';
    li.draggable = true;
    li.dataset.fieldType = fieldType;
    
    const fieldCount = list.children.length;
    
    li.innerHTML = `
        <span><i class="fas fa-grip-vertical me-2 text-muted"></i>${fieldLabel}</span>
        <input type="hidden" name="pages[${pageIndex}][fields][${fieldCount}][type]" value="${fieldType}" class="field-type-input">
        <input type="hidden" name="pages[${pageIndex}][fields][${fieldCount}][label]" value="${fieldLabel}" class="field-label-input">
        <input type="hidden" name="pages[${pageIndex}][fields][${fieldCount}][order]" value="${fieldCount}" class="field-order-input">
    `;
    
    list.appendChild(li);
    
    // Reinitialize drag handlers for new item
    initDragHandlers(li);
}

function removeFieldFromList(list, fieldType) {
    const item = list.querySelector(`[data-field-type="${fieldType}"]`);
    if (item) {
        item.remove();
    }
}

function updateEmptyMessage(list, emptyMessage) {
    if (!emptyMessage) return;
    
    if (list.children.length === 0) {
        emptyMessage.style.display = 'block';
    } else {
        emptyMessage.style.display = 'none';
    }
}

function updateFieldOrders(list, pageIndex) {
    const items = list.querySelectorAll('.field-order-item');
    items.forEach(function(item, index) {
        const typeInput = item.querySelector('.field-type-input');
        const labelInput = item.querySelector('.field-label-input');
        const orderInput = item.querySelector('.field-order-input');
        
        // Update input names and order
        if (typeInput) {
            typeInput.name = `pages[${pageIndex}][fields][${index}][type]`;
        }
        if (labelInput) {
            labelInput.name = `pages[${pageIndex}][fields][${index}][label]`;
        }
        if (orderInput) {
            orderInput.name = `pages[${pageIndex}][fields][${index}][order]`;
            orderInput.value = index;
        }
    });
}

function enableDragAndDrop(list, pageIndex, emptyMessage) {
    const items = list.querySelectorAll('.field-order-item');
    items.forEach(function(item) {
        initDragHandlers(item);
    });
    
    list.addEventListener('dragover', function(e) {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        const dragging = document.querySelector('.dragging');
        
        if (afterElement == null) {
            list.appendChild(dragging);
        } else {
            list.insertBefore(dragging, afterElement);
        }
    });
    
    list.addEventListener('drop', function(e) {
        e.preventDefault();
        updateFieldOrders(list, pageIndex);
    });
}

function initDragHandlers(item) {
    item.addEventListener('dragstart', function() {
        this.classList.add('dragging');
    });
    
    item.addEventListener('dragend', function() {
        this.classList.remove('dragging');
        document.querySelectorAll('.drag-over').forEach(function(el) {
            el.classList.remove('drag-over');
        });
    });
}

function getDragAfterElement(list, y) {
    const draggableElements = [...list.querySelectorAll('.field-order-item:not(.dragging)')];
    
    return draggableElements.reduce(function(closest, child) {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}
</script>
{% endblock %}