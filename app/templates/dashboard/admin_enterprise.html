{% extends "layout.html" %}

{% block title %}Dashboard Enterprise - Admin{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
<div class="container-fluid px-3 px-lg-4">
    <!-- Header Section -->
    <section class="dashboard-section">
        <div class="dashboard-header">
            <div>
                <h1 class="dashboard-title"><i class="fas fa-tachometer-alt text-primary me-2"></i>Dashboard Enterprise</h1>
                <p class="dashboard-subtitle">Visão geral completa do sistema em tempo real.</p>
            </div>
            <div class="dashboard-actions">
                <button type="button" class="btn btn-sm btn-outline-primary" data-dashboard-action="refresh">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <a href="{{ url_for('admin.audit_logs') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-clipboard-list"></i> Logs
                </a>
            </div>
        </div>
    </section>

    <!-- Payment KPI Spotlight -->
    <div class="row g-3 mb-4 payment-kpis">
        <div class="col-12">
            <div class="dashboard-card kpi-header-card">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                    <div>
                        <div class="dashboard-card-eyebrow text-uppercase small fw-semibold text-muted">Pagamentos Heleket</div>
                        <h4 class="dashboard-card-title mb-1">Performance de payouts (últimos {{ payout_insights.summary.period_days }} dias)</h4>
                        <p class="mb-0 text-muted">Monitoramento consolidado de transferências cripto: confirme tendências, encontre gargalos e mantenha o fluxo saudável.</p>
                    </div>
                    <div class="text-md-end">
                        <div class="total-amount-display">Total movimentado: <strong>{{ "%.2f"|format(payout_insights.summary.total_amount|float) }}</strong></div>
                        <a class="btn btn-sm btn-primary mt-2" href="{{ url_for('client.list_clients') }}#payout-ready">
                            <i class="fas fa-coins me-1"></i> Ver pagamentos
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-4">
            <div class="stat-card payout-card success">
                <div class="stat-card-icon bg-success-soft text-success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-number">{{ payout_insights.summary.confirmed.count }}</div>
                <div class="stat-label">Pagos</div>
                <p class="stat-meta mb-1">{{ "%.2f"|format(payout_insights.summary.confirmed.amount|float) }} confirmados</p>
                <div class="stat-progress">
                    {% set total = payout_insights.summary.total_count or 1 %}
                    {% set percent = (payout_insights.summary.confirmed.count / total * 100) if total > 0 else 0 %}
                    {% set percent_floor = percent|round(0, 'floor') %}
                    <div class="progress-thin progress-has-variable" style="--progress-width: {{ percent_floor }}%;">
                        <div class="progress-bar bg-success"></div>
                    </div>
                    <small class="text-muted">{{ percent|round(1) }}% do volume</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="stat-card payout-card warning">
                <div class="stat-card-icon bg-warning-soft text-warning">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="stat-number">{{ payout_insights.summary.pending.count }}</div>
                <div class="stat-label">Em andamento</div>
                <p class="stat-meta mb-1">{{ "%.2f"|format(payout_insights.summary.pending.amount|float) }} aguardando confirmação</p>
                <div class="stat-progress">
                    {% set total = payout_insights.summary.total_count or 1 %}
                    {% set percent = (payout_insights.summary.pending.count / total * 100) if total > 0 else 0 %}
                    {% set percent_floor = percent|round(0, 'floor') %}
                    <div class="progress-thin progress-has-variable" style="--progress-width: {{ percent_floor }}%;">
                        <div class="progress-bar bg-warning"></div>
                    </div>
                    <small class="text-muted">{{ percent|round(1) }}% do volume</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="stat-card payout-card danger">
                <div class="stat-card-icon bg-danger-soft text-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-number">{{ payout_insights.summary.failed.count }}</div>
                <div class="stat-label">Intervenção</div>
                <p class="stat-meta mb-1">{{ "%.2f"|format(payout_insights.summary.failed.amount|float) }} requer atenção</p>
                <div class="stat-progress">
                    {% set total = payout_insights.summary.total_count or 1 %}
                    {% set percent = (payout_insights.summary.failed.count / total * 100) if total > 0 else 0 %}
                    {% set percent_floor = percent|round(0, 'floor') %}
                    <div class="progress-thin progress-has-variable" style="--progress-width: {{ percent_floor }}%;">
                        <div class="progress-bar bg-danger"></div>
                    </div>
                    <small class="text-muted">{{ percent|round(1) }}% do volume</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards - Full Width Responsive Grid -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-4 col-lg-2">
            <div class="stat-card payout-highlight success">
                <div class="stat-number">R$ {{ "%.2f"|format(payout_insights.summary.total_amount|float) }}</div>
                <div class="stat-label">Pagamentos {{ payout_insights.summary.period_days }} dias</div>
                <div class="growth-indicator">
                    Taxa de sucesso {{ payout_insights.summary.confirmation_rate|round(1) }}%
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <span class="badge bg-success-soft text-success fw-semibold">
                        <i class="fas fa-check-circle me-1"></i>{{ payout_insights.summary.confirmed.count }} pagos
                    </span>
                    <a href="{{ url_for('client.list_clients') }}#payout-ready" class="stat-link">
                        Ver histórico
                    </a>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="stat-card success">
                <div class="stat-number">{{ stats.total_clients }}</div>
                <div class="stat-label">Total Clientes</div>
                <div class="growth-indicator growth-up">
                    <i class="fas fa-arrow-up"></i> +{{ new_clients }} este mês
                </div>
                <small class="stat-meta">{{ stats.active_clients }} ativos ({{ "%.1f"|format((stats.active_clients / stats.total_clients * 100) if stats.total_clients > 0 else 0) }}%)</small>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="stat-card info">
                <div class="stat-number">{{ stats.total_infos }}</div>
                <div class="stat-label">Total Infos</div>
                <div class="growth-indicator growth-up">
                    <i class="fas fa-arrow-up"></i> +{{ new_infos }}
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="stat-card warning">
                <div class="stat-number">{{ stats.total_domains }}</div>
                <div class="stat-label">Domínios</div>
                <div class="growth-indicator">
                    {{ stats.total_plans }} planos
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="stat-card info">
                <div class="stat-number">{{ stats.total_clicks }}</div>
                <div class="stat-label">Total Clicks</div>
                <div class="growth-indicator">
                    30 dias
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="stat-card danger">
                <div class="stat-number">{{ stats.total_admins }}</div>
                <div class="stat-label">Admins</div>
                <div class="growth-indicator">
                    Sistema
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row - Charts and Activity -->
    <div class="row g-3 mb-4">
        <!-- Left Column - Charts (Larger on desktop) -->
        <div class="col-12 col-lg-8">
            <!-- Payments Chart -->
            <div class="dashboard-card mb-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-coins text-primary me-2"></i>Status dos Pagamentos</h5>
                    <span class="badge bg-primary">{{ payout_insights.summary.total_count }} transações</span>
                </div>
                <div class="chart-container chart-loading" data-chart="payout-status" aria-live="polite" aria-busy="true">
                    <div class="chart-skeleton" aria-hidden="true"></div>
                    <canvas id="payoutStatusChart" role="img" aria-label="Distribuição de status de payouts"></canvas>
                </div>
                <div class="payout-legend mt-3">
                    <div class="row g-3 text-center">
                        <div class="col-4">
                            <p class="legend-label text-success mb-0">Confirmados</p>
                            <small class="text-muted">{{ payout_insights.summary.confirmed.count }} / {{ "%.2f"|format(payout_insights.summary.confirmed.amount|float) }}</small>
                        </div>
                        <div class="col-4">
                            <p class="legend-label text-primary mb-0">Pendentes</p>
                            <small class="text-muted">{{ payout_insights.summary.pending.count }} / {{ "%.2f"|format(payout_insights.summary.pending.amount|float) }}</small>
                        </div>
                        <div class="col-4">
                            <p class="legend-label text-danger mb-0">Falhos</p>
                            <small class="text-muted">{{ payout_insights.summary.failed.count }} / {{ "%.2f"|format(payout_insights.summary.failed.amount|float) }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clicks Chart - Full Width -->
            <div class="dashboard-card mb-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-chart-line text-info me-2"></i>Clicks nos Últimos 30 Dias</h5>
                    <span class="badge bg-info">{{ stats.total_clicks }} total</span>
                </div>
                <div class="chart-container chart-loading" data-chart="admin-clicks" aria-live="polite" aria-busy="true">
                    <div class="chart-skeleton" aria-hidden="true"></div>
                    <canvas id="adminClicksChart" role="img" aria-label="Gráfico de clicks nos últimos 30 dias"></canvas>
                </div>
            </div>

            <!-- Distribution Charts Row -->
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <div class="dashboard-card">
                        <h5 class="mb-3"><i class="fas fa-chart-pie text-primary me-2"></i>Distribuição de Planos</h5>
                        <div class="chart-container chart-loading" data-chart="plan-distribution" aria-live="polite" aria-busy="true">
                            <div class="chart-skeleton" aria-hidden="true"></div>
                            <canvas id="planChart" role="img" aria-label="Distribuição de planos"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="dashboard-card">
                        <h5 class="mb-3"><i class="fas fa-chart-bar text-success me-2"></i>Status dos Clientes</h5>
                        <div class="chart-container chart-loading" data-chart="status-distribution" aria-live="polite" aria-busy="true">
                            <div class="chart-skeleton" aria-hidden="true"></div>
                            <canvas id="statusChart" role="img" aria-label="Status dos clientes"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Activity and Summary -->
        <div class="col-12 col-lg-4">
            <!-- System Summary Card -->
            <div class="dashboard-card mb-3">
                <h5 class="mb-3"><i class="fas fa-server text-success me-2"></i>Resumo do Sistema</h5>
                <div class="row text-center g-2">
                    <div class="col-6">
                        <div class="p-2 bg-light rounded">
                            <div class="h4 mb-1 text-primary">{{ stats.total_templates }}</div>
                            <small class="text-muted">Templates</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 bg-light rounded">
                            <div class="h4 mb-1 text-success">{{ stats.active_infos }}</div>
                            <small class="text-muted">Infos Ativas</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 bg-light rounded">
                            <div class="h4 mb-1 text-warning">{{ stats.inactive_clients }}</div>
                            <small class="text-muted">Inativos</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 bg-light rounded">
                            <div class="h4 mb-1 text-info">{{ stats.total_domains }}</div>
                            <small class="text-muted">Domínios</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Logins -->
            <div class="dashboard-card">
                <h5 class="mb-3"><i class="fas fa-sign-in-alt text-warning me-2"></i>Logins Recentes</h5>
                <div class="recent-activity" style="max-height: 350px;">
                    {% for login in recent_logins[:5] %}
                    <div class="activity-item">
                        <div class="flex-grow-1">
                            <strong class="d-block">{{ login.username or 'Usuário' }}</strong>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                {{ login.created_at.strftime('%d/%m %H:%M') if login.created_at else 'N/A' }}
                            </small>
                        </div>
                        <span class="badge bg-primary">{{ login.role or 'client' }}</span>
                    </div>
                    {% endfor %}
                    {% if not recent_logins %}
                    <div class="dashboard-empty" role="status" aria-live="polite">
                        <i class="fas fa-inbox"></i>
                        <p class="mb-0 small">Nenhuma atividade recente</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Clicks Log Section - Full Width -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-mouse-pointer text-danger me-2"></i>Últimos Clicks Registrados</h5>
                    <span class="badge bg-danger">{{ recent_clicks|length }} registros</span>
                </div>
                {% if recent_clicks %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-nowrap"><i class="fas fa-clock me-1"></i>Data/Hora</th>
                                <th class="text-nowrap"><i class="fas fa-user me-1"></i>Usuário</th>
                                <th class="text-nowrap"><i class="fas fa-globe me-1"></i>Domínio</th>
                                <th class="text-nowrap"><i class="fas fa-network-wired me-1"></i>IP</th>
                                <th class="text-nowrap d-none d-lg-table-cell"><i class="fas fa-desktop me-1"></i>User Agent</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for click in recent_clicks %}
                            <tr>
                                <td class="text-nowrap">
                                    <small>{{ click.timestamp.strftime('%d/%m/%Y %H:%M:%S') if click.timestamp else 'N/A' }}</small>
                                </td>
                                <td>
                                    <strong class="text-primary">{{ click.username or 'Desconhecido' }}</strong>
                                </td>
                                <td class="text-truncate" style="max-width: 200px;">
                                    {% if click.subdomain and click.domain_name %}
                                        <code class="small">{{ click.subdomain }}.{{ click.domain_name }}</code>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ click.ip_address or 'N/A' }}</span>
                                </td>
                                <td class="text-truncate d-none d-lg-table-cell" style="max-width: 300px;" title="{{ click.user_agent }}">
                                    <small class="text-muted">{{ click.user_agent or 'N/A' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="dashboard-empty" role="status" aria-live="polite">
                    <i class="fas fa-mouse-pointer"></i>
                    <p class="text-muted mb-0">Nenhum click registrado ainda.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Actions - Full Width -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <h5 class="mb-3"><i class="fas fa-bolt text-warning me-2"></i>Ações Rápidas</h5>
                <div class="row g-2 quick-actions">
                    <div class="col-6 col-md-4 col-lg-2">
                        <a href="{{ url_for('client.create_client') }}" class="btn btn-primary w-100">
                            <i class="fas fa-user-plus"></i> <span class="d-none d-sm-inline">Novo</span> Cliente
                        </a>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <a href="{{ url_for('plan.create_plan') }}" class="btn btn-success w-100">
                            <i class="fas fa-plus"></i> <span class="d-none d-sm-inline">Novo</span> Plano
                        </a>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <a href="{{ url_for('domain.create_domain') }}" class="btn btn-info w-100">
                            <i class="fas fa-globe"></i> <span class="d-none d-sm-inline">Novo</span> Domínio
                        </a>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <a href="{{ url_for('template.create_template') }}" class="btn btn-warning w-100">
                            <i class="fas fa-file-alt"></i> <span class="d-none d-sm-inline">Novo</span> Template
                        </a>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('client.list_clients') }}" class="btn btn-secondary">
                                <i class="fas fa-list"></i> Ver Clientes
                            </a>
                            <a href="{{ url_for('client.list_clients') }}#payout-ready" class="btn btn-outline-primary" data-quick-action="payout">
                                <i class="fas fa-coins"></i> Disparar payout
                            </a>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <a href="{{ url_for('admin.audit_logs') }}" class="btn btn-dark w-100">
                            <i class="fas fa-history"></i> Logs Audit
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Dashboard JavaScript is loaded from external file -->
{% endblock %}