{% set info_active_percentage = (active_infos / info_count * 100) if info_count > 0 else 0 %}

<section class="dashboard-section">
    <div class="dashboard-header">
        <div>
            <h1 class="dashboard-title"><i class="fas fa-tachometer-alt text-primary me-2"></i>Painel Administrativo</h1>
            <p class="dashboard-subtitle">Acompanhe clientes, planos e atividade em tempo real.</p>
        </div>
        <div class="dashboard-actions">
            <button type="button" class="btn btn-sm btn-outline-primary" data-dashboard-action="refresh">
                <i class="fas fa-sync-alt me-1"></i>Atualizar
            </button>
            <a href="{{ url_for('admin.audit_logs') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-clipboard-list me-1"></i>Logs
            </a>
        </div>
    </div>
</section>

<section class="dashboard-section">
    <div class="row g-3">
        <div class="col-12 col-sm-6 col-xl-3">
            <article class="stat-card dashboard-stat">
                <div class="stat-card-icon bg-primary-subtle text-primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number">{{ client_count }}</div>
                <div class="stat-label">Total de Clientes</div>
                <p class="stat-meta"><i class="fas fa-check-circle me-1"></i>{{ active_clients }} ativos</p>
                <a class="stat-link" href="{{ url_for('client.list_clients') }}">Ver todos <i class="fas fa-arrow-right ms-1"></i></a>
            </article>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <article class="stat-card dashboard-stat success">
                <div class="stat-card-icon bg-success-subtle text-success">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div class="stat-number">{{ plan_count }}</div>
                <div class="stat-label">Total de Planos</div>
                <p class="stat-meta"><i class="fas fa-tags me-1"></i>Planos ativos</p>
                <a class="stat-link" href="{{ url_for('plan.list_plans') }}">Ver todos <i class="fas fa-arrow-right ms-1"></i></a>
            </article>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <article class="stat-card dashboard-stat info">
                <div class="stat-card-icon bg-info-subtle text-info">
                    <i class="fas fa-globe"></i>
                </div>
                <div class="stat-number">{{ domain_count }}</div>
                <div class="stat-label">Domínios</div>
                <p class="stat-meta"><i class="fas fa-network-wired me-1"></i>{{ template_count }} templates</p>
                <a class="stat-link" href="{{ url_for('domain.list_domains') }}">Ver todos <i class="fas fa-arrow-right ms-1"></i></a>
            </article>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
            <article class="stat-card dashboard-stat warning">
                <div class="stat-card-icon bg-warning-subtle text-warning">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-number">{{ admin_count }}</div>
                <div class="stat-label">Administradores</div>
                <p class="stat-meta"><i class="fas fa-shield-alt me-1"></i>Equipe do sistema</p>
                <a class="stat-link" href="{{ url_for('admin.list_admins') }}">Ver todos <i class="fas fa-arrow-right ms-1"></i></a>
            </article>
        </div>
    </div>
</section>

<section class="dashboard-section">
    <div class="row g-3">
        <div class="col-12 col-lg-6">
            <article class="dashboard-card metric-card">
                <div class="dashboard-card-header">
                    <div>
                        <p class="dashboard-card-eyebrow">Informações bancárias</p>
                        <h3 class="dashboard-card-title">{{ info_count }}</h3>
                    </div>
                    <span class="badge bg-primary-subtle text-primary"><i class="fas fa-university me-1"></i>{{ active_infos }} ativos</span>
                </div>
                <div class="progress progress-thin progress-has-variable" role="progressbar" aria-label="Porcentagem de informações ativas" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ info_active_percentage|round(1) }}" style="--progress-width: {{ info_active_percentage }}%;">
                    <div class="progress-bar bg-primary"></div>
                </div>
                <p class="text-muted small mb-0">
                    {% if info_count > 0 %}
                        {{ "%.1f"|format(info_active_percentage) }}% estão ativos
                    {% else %}
                        Nenhum registro ainda
                    {% endif %}
                </p>
            </article>
        </div>
        <div class="col-12 col-lg-6">
            <article class="dashboard-card metric-card">
                <div class="dashboard-card-header">
                    <div>
                        <p class="dashboard-card-eyebrow">Modelos</p>
                        <h3 class="dashboard-card-title">{{ template_count }}</h3>
                    </div>
                    <span class="badge bg-secondary-subtle text-secondary"><i class="fas fa-file-code me-1"></i>Disponíveis</span>
                </div>
                <div class="d-flex flex-wrap gap-2 mt-3">
                    <a href="{{ url_for('template.list_templates') }}" class="btn btn-outline-primary btn-sm flex-grow-1">
                        <i class="fas fa-list me-1"></i>Ver modelos
                    </a>
                    <a href="{{ url_for('template.create_template') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Novo
                    </a>
                </div>
            </article>
        </div>
    </div>
</section>

<section class="dashboard-section">
    <div class="row g-3">
        <div class="col-12 col-lg-6">
            <article class="dashboard-card h-100">
                <div class="dashboard-card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt text-warning me-2"></i>Ações rápidas</h5>
                </div>
                <div class="dashboard-action-list">
                    <a href="{{ url_for('client.create_client') }}" class="dashboard-action-link">
                        <i class="fas fa-user-plus"></i><span>Adicionar novo cliente</span>
                    </a>
                    <a href="{{ url_for('plan.create_plan') }}" class="dashboard-action-link">
                        <i class="fas fa-plus-circle"></i><span>Criar novo plano</span>
                    </a>
                    <a href="{{ url_for('domain.create_domain') }}" class="dashboard-action-link">
                        <i class="fas fa-globe"></i><span>Registrar novo domínio</span>
                    </a>
                    {% if user.role == 'super_admin' %}
                    <a href="{{ url_for('admin.create_admin') }}" class="dashboard-action-link">
                        <i class="fas fa-user-shield"></i><span>Adicionar novo administrador</span>
                    </a>
                    {% endif %}
                    <a href="{{ url_for('client.list_clients') }}#payout-ready" class="dashboard-action-link" data-quick-action="payout">
                        <i class="fas fa-coins"></i><span>Disparar payout</span>
                    </a>
                </div>
            </article>
        </div>
        <div class="col-12 col-lg-6">
            <article class="dashboard-card h-100">
                <div class="dashboard-card-header">
                    <h5 class="mb-0"><i class="fas fa-user-circle text-primary me-2"></i>Perfil do administrador</h5>
                </div>
                <div class="dashboard-profile">
                    <div class="dashboard-profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h5 class="mb-1">{{ user.username }}</h5>
                        <span class="badge bg-primary">{{ user.role }}</span>
                    </div>
                </div>
                <div>
                    <small class="text-muted d-block mb-1">Último acesso</small>
                    <strong>{% if user.last_login %}{{ user.last_login.strftime('%d/%m/%Y %H:%M') }}{% else %}N/D{% endif %}</strong>
                </div>
                <a href="{{ url_for('admin.profile') }}" class="btn btn-primary w-100 mt-3">
                    <i class="fas fa-user-edit me-2"></i>Editar perfil
                </a>
            </article>
        </div>
    </div>
</section>

<section class="dashboard-section">
    <article class="dashboard-card">
        <div class="dashboard-card-header">
            <h5 class="mb-0"><i class="fas fa-database text-success me-2"></i>Informações de clientes</h5>
            <span class="badge bg-success-subtle text-success">{{ infos_detailed|length }} registros</span>
        </div>
        {% if infos_detailed %}
        <div class="table-responsive dashboard-table" data-table-wrapper>
            <table class="table table-hover align-middle mb-0" data-sortable-table>
                <thead class="table-light">
                    <tr>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="0" data-sort-type="text">
                                Cliente <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="1" data-sort-type="text">
                                Agência <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="2" data-sort-type="text">
                                Conta <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="3" data-sort-type="number">
                                Saldo <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="4" data-sort-type="text">
                                Status <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="5" data-sort-type="number">
                                Atualizado <i class="fas fa-sort"></i>
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for info in infos_detailed %}
                    <tr>
                        <td data-label="Cliente">
                            <div class="d-flex flex-column">
                                <strong>{{ info.client_username }}</strong>
                                <small class="text-muted text-uppercase">{{ info.client_status|default('N/D') }}</small>
                            </div>
                        </td>
                        <td data-label="Agência">{{ info.agencia }}</td>
                        <td data-label="Conta">{{ info.conta }}</td>
                        <td class="text-success fw-semibold" data-label="Saldo" data-sort-value="{{ info.saldo|default(0) }}">R$ {{ "%.2f"|format(info.saldo|default(0)) }}</td>
                        <td data-label="Status">
                            {% if info.status == 'active' %}
                            <span class="badge bg-success">Ativo</span>
                            {% elif info.status == 'inactive' %}
                            <span class="badge bg-warning text-dark">Inativo</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ info.status }}</span>
                            {% endif %}
                        </td>
                        <td data-label="Atualizado" data-sort-value="{% if info.updatedAt %}{{ info.updatedAt.timestamp() }}{% else %}0{% endif %}">{% if info.updatedAt %}{{ info.updatedAt.strftime('%d/%m/%Y %H:%M') }}{% else %}—{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="table-card-list d-lg-none" data-table-cards>
            {% for info in infos_detailed %}
            <article class="table-card">
                <div class="table-card-row">
                    <span class="table-card-label">Cliente</span>
                    <span class="table-card-value">{{ info.client_username }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Status</span>
                    <span class="table-card-value text-uppercase">{{ info.status|default('N/D') }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Agência</span>
                    <span class="table-card-value">{{ info.agencia }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Conta</span>
                    <span class="table-card-value">{{ info.conta }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Saldo</span>
                    <span class="table-card-value text-success fw-semibold">R$ {{ "%.2f"|format(info.saldo|default(0)) }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Atualizado</span>
                    <span class="table-card-value">{% if info.updatedAt %}{{ info.updatedAt.strftime('%d/%m/%Y %H:%M') }}{% else %}—{% endif %}</span>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
    <div class="dashboard-empty" role="status" aria-live="polite">
            <i class="fas fa-database"></i>
            <p>Nenhum registro de informação encontrado.</p>
        </div>
        {% endif %}
    </article>
</section>

<section class="dashboard-section">
    <article class="dashboard-card">
        <div class="dashboard-card-header flex-wrap gap-2">
            <h5 class="mb-0"><i class="fas fa-history text-info me-2"></i>Últimos logins</h5>
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <a href="{{ url_for('admin.audit_logs') }}" class="btn btn-outline-info btn-sm">
                    <i class="fas fa-clipboard-list me-1"></i>Ver Logs de Auditoria
                </a>
                <span class="badge bg-info-subtle text-info">{{ recent_login_logs|length }} registros</span>
            </div>
        </div>
        {% if recent_login_logs %}
        <div class="table-responsive dashboard-table" data-table-wrapper>
            <table class="table table-hover align-middle mb-0" data-sortable-table>
                <thead class="table-light">
                    <tr>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="0" data-sort-type="text">
                                Usuário <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="1" data-sort-type="text">
                                Função <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="2" data-sort-type="text">
                                Tipo <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="3" data-sort-type="text">
                                IP <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col">
                            <button type="button" class="table-sort" data-column-index="4" data-sort-type="number">
                                Data <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th scope="col" class="table-col-wide">
                            <button type="button" class="table-sort" data-column-index="5" data-sort-type="text">
                                Agente <i class="fas fa-sort"></i>
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_login_logs %}
                    <tr>
                        <td data-label="Usuário"><strong>{{ log.username }}</strong></td>
                        <td data-label="Função"><span class="badge bg-primary text-uppercase">{{ log.role or 'client' }}</span></td>
                        <td data-label="Tipo">{{ log.user_type|default('client') }}</td>
                        <td data-label="IP">{{ log.ip_address|default('—') }}</td>
                        <td data-label="Data" data-sort-value="{% if log.created_at %}{{ log.created_at.timestamp() }}{% else %}0{% endif %}">{% if log.created_at %}{{ log.created_at.strftime('%d/%m/%Y %H:%M') }}{% else %}—{% endif %}</td>
                        <td class="table-col-wide" data-label="Agente" title="{{ log.user_agent }}">{{ log.user_agent|default('—') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="table-card-list d-lg-none" data-table-cards>
            {% for log in recent_login_logs %}
            <article class="table-card">
                <div class="table-card-row">
                    <span class="table-card-label">Usuário</span>
                    <span class="table-card-value">{{ log.username }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Função</span>
                    <span class="table-card-value text-uppercase">{{ log.role or 'client' }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Tipo</span>
                    <span class="table-card-value">{{ log.user_type|default('client') }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">IP</span>
                    <span class="table-card-value">{{ log.ip_address|default('—') }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Data</span>
                    <span class="table-card-value">{% if log.created_at %}{{ log.created_at.strftime('%d/%m/%Y %H:%M') }}{% else %}—{% endif %}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Agente</span>
                    <span class="table-card-value">{{ log.user_agent|default('—') }}</span>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
    <div class="dashboard-empty" role="status" aria-live="polite">
            <i class="fas fa-inbox"></i>
            <p>Nenhum login registrado ainda.</p>
        </div>
        {% endif %}
    </article>
</section>

<section class="dashboard-section">
    <article class="dashboard-card">
        <div class="dashboard-card-header">
            <h5 class="mb-0"><i class="fas fa-mouse-pointer text-danger me-2"></i>Últimos clicks registrados</h5>
            <span class="badge bg-danger-subtle text-danger">{{ recent_clicks|length }} registros</span>
        </div>
        {% if recent_clicks %}
        <div class="table-responsive dashboard-table" data-table-wrapper>
            <table class="table table-hover table-sm align-middle mb-0" data-sortable-table>
                <thead class="table-light">
                    <tr>
                        <th class="text-nowrap" scope="col">
                            <button type="button" class="table-sort" data-column-index="0" data-sort-type="number">
                                Data/Hora <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th class="text-nowrap" scope="col">
                            <button type="button" class="table-sort" data-column-index="1" data-sort-type="text">
                                Usuário <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th class="text-nowrap" scope="col">
                            <button type="button" class="table-sort" data-column-index="2" data-sort-type="text">
                                Domínio <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th class="text-nowrap" scope="col">
                            <button type="button" class="table-sort" data-column-index="3" data-sort-type="text">
                                IP <i class="fas fa-sort"></i>
                            </button>
                        </th>
                        <th class="text-nowrap d-none d-lg-table-cell" scope="col">
                            <button type="button" class="table-sort" data-column-index="4" data-sort-type="text">
                                User Agent <i class="fas fa-sort"></i>
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for click in recent_clicks %}
                    <tr>
                        <td class="text-nowrap" data-label="Data/Hora" data-sort-value="{% if click.timestamp %}{{ click.timestamp.timestamp() }}{% else %}0{% endif %}"><small>{{ click.timestamp.strftime('%d/%m/%Y %H:%M:%S') if click.timestamp else 'N/A' }}</small></td>
                        <td data-label="Usuário"><strong class="text-primary">{{ click.username or 'Desconhecido' }}</strong></td>
                        <td class="table-col-wide" data-label="Domínio">
                            {% if click.subdomain and click.domain_name %}
                                <code class="small">{{ click.subdomain }}.{{ click.domain_name }}</code>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td data-label="IP"><span class="badge bg-secondary">{{ click.ip_address or 'N/A' }}</span></td>
                        <td class="table-col-wide d-none d-lg-table-cell" data-label="User Agent" title="{{ click.user_agent }}">
                            <small class="text-muted">{{ click.user_agent|default('N/A') }}</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="table-card-list d-lg-none" data-table-cards>
            {% for click in recent_clicks %}
            <article class="table-card">
                <div class="table-card-row">
                    <span class="table-card-label">Data/Hora</span>
                    <span class="table-card-value">{{ click.timestamp.strftime('%d/%m/%Y %H:%M:%S') if click.timestamp else 'N/A' }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Usuário</span>
                    <span class="table-card-value">{{ click.username or 'Desconhecido' }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">Domínio</span>
                    <span class="table-card-value">
                        {% if click.subdomain and click.domain_name %}
                            {{ click.subdomain }}.{{ click.domain_name }}
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">IP</span>
                    <span class="table-card-value">{{ click.ip_address or 'N/A' }}</span>
                </div>
                <div class="table-card-row">
                    <span class="table-card-label">User Agent</span>
                    <span class="table-card-value">{{ click.user_agent|default('N/A') }}</span>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
    <div class="dashboard-empty" role="status" aria-live="polite">
            <i class="fas fa-mouse-pointer"></i>
            <p>Nenhum click registrado ainda.</p>
        </div>
        {% endif %}
    </article>
</section>
