#!/bin/sh

echo "üîç Executando verifica√ß√µes de pr√©-commit..."

# Verificar se h√° arquivos Python modificados
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')

if [ -n "$PYTHON_FILES" ]; then
  echo "üìù Verificando c√≥digo Python com flake8..."
  echo "$PYTHON_FILES" | xargs flake8 --count --select=E9,F63,F7,F82 --show-source --statistics
  
  if [ $? -ne 0 ]; then
    echo "‚ùå Erros de c√≥digo encontrados. Corrija antes de commitar."
    exit 1
  fi
  
  echo "üîí Verificando por credenciais expostas..."
  echo "$PYTHON_FILES" | xargs grep -l "API_KEY\|SECRET\|PASSWORD\|TOKEN" | grep -v "\.env\.example\|\.env\.production\.example" && {
    echo "‚ùå Poss√≠vel exposi√ß√£o de credenciais detectada!"
    exit 1
  }
fi

# Verificar se h√° arquivos .env sendo commitados
ENV_FILES=$(git diff --cached --name-only | grep '\.env$')
if [ -n "$ENV_FILES" ]; then
  echo "‚ùå Arquivo .env detectado no commit. Remova antes de commitar."
  exit 1
fi

echo "‚úÖ Pr√©-commit passou com sucesso!"